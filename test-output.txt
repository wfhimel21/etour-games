
> e-tour@1.0.0 test
> hardhat test

[dotenv@17.2.3] injecting env (1) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
StateTracker initialized: object
StateTracker methods: [
  'constructor',
  'startTest',
  'recordTimelineEntry',
  'endTest',
  'isTracking',
  'getTestData',
  'getAllTests',
  'getCurrentTestId',
  'getSummary',
  'getTestsByFile',
  'getTestsByStatus',
  'clear',
  'toJSON',
  'fromJSON'
]
Scientific test reporter setup complete. State capture enabled.


  All-Draw Prize Distribution Edge Cases
    Finals Draw Scenarios
      âœ” Should split prize equally for finals draw with standard prize pool
      âœ” Should update tournament finalsWasDraw flag correctly
    Semi-Finals All-Draw Scenarios
      âœ” Should split prize among 4 players when both semi-finals draw
      âœ” Should correctly set allDrawResolution and allDrawRound flags
    8-Player All-Draw Round 0 Scenario
      âœ” Should split prize among 8 players if all round 0 matches draw (41ms)
    Mixed Results Scenarios
Matches may have been cached after tournament completion
      âœ” Should handle one draw and three wins in 8-player tournament
    Player Stats for All-Draw Scenarios
      âœ” Should update player stats correctly for all-draw tournament

  Arbitrum Storage Gas Cost Analysis - playerMatches Growth

==========================================
ARBITRUM STORAGE GAS COST ANALYSIS
ðŸš¨ EXTREME STRESS TEST ðŸš¨
==========================================
Wallets (requested): 20
Matches per wallet: 200
Total matches (requested): 4,000
Total MatchRecords (requested): 8,000 (2 per match)

âš ï¸  WARNING: This test will take HOURS to complete!
âš ï¸  Each wallet will accumulate 10,000 MatchRecords
âš ï¸  Testing unbounded array growth at extreme scale
==========================================

âœ“ Loaded 20 wallets

Measurement points: 1, 10, 25, 50, 100, 200

Deploying modules...
âœ“ Modules deployed

Deploying ChessOnChain...
âœ“ ChessOnChain deployed


ðŸš€ Starting mass match simulation...


ðŸ“Š Wallet 1/20 (0xf39Fd6e5...)
  Match 1/200: Total gas = 4,421,586, Move4 (w/ MatchRecord) = 2,657,450
  Match 10/200: Total gas = 4,375,158, Move4 (w/ MatchRecord) = 2,628,062
  Match 25/200: Total gas = 4,293,543, Move4 (w/ MatchRecord) = 2,546,405
  Match 50/200: Total gas = 4,293,543, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,113,856, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,091,198, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 200 MatchRecords in storage

ðŸ“Š Wallet 2/20 (0x70997970...)
  Match 1/200: Total gas = 4,131,743, Move4 (w/ MatchRecord) = 2,418,305
  Match 10/200: Total gas = 4,092,201, Move4 (w/ MatchRecord) = 2,381,305
  Match 25/200: Total gas = 4,179,158, Move4 (w/ MatchRecord) = 2,465,762
  Match 50/200: Total gas = 4,293,501, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,083,801, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,093,956, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 220 MatchRecords in storage

ðŸ“Š Wallet 3/20 (0x3C44CdDd...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,456, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 220 MatchRecords in storage

ðŸ“Š Wallet 4/20 (0x90F79bf6...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,091,901, Move4 (w/ MatchRecord) = 2,378,505
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,343, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,093,656, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 240 MatchRecords in storage

ðŸ“Š Wallet 5/20 (0x15d34AAf...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,398, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,093,656, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 240 MatchRecords in storage

ðŸ“Š Wallet 6/20 (0x9965507D...)
  Match 1/200: Total gas = 4,114,601, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,094,701, Move4 (w/ MatchRecord) = 2,381,305
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,498, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 260 MatchRecords in storage

ðŸ“Š Wallet 7/20 (0x976EA740...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,398, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,498, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 260 MatchRecords in storage

ðŸ“Š Wallet 8/20 (0x14dC7996...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,114,601, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,093,698, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 280 MatchRecords in storage

ðŸ“Š Wallet 9/20 (0x23618e81...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,398, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,498, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 280 MatchRecords in storage

ðŸ“Š Wallet 10/20 (0xa0Ee7A14...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,456, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 300 MatchRecords in storage

ðŸ“Š Wallet 11/20 (0xBcd4042D...)
  Match 1/200: Total gas = 4,114,601, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,114,601, Move4 (w/ MatchRecord) = 2,401,205
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,343, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,096,498, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 300 MatchRecords in storage

ðŸ“Š Wallet 12/20 (0x71bE63f3...)
  Match 1/200: Total gas = 4,114,643, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,099,256, Move4 (w/ MatchRecord) = 2,385,860
  Match 25/200: Total gas = 4,119,498, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  âœ“ Wallet now has 320 MatchRecords in storage

ðŸ“Š Wallet 13/20 (0xFABB0ac9...)
  Match 1/200: Total gas = 4,114,601, Move4 (w/ MatchRecord) = 2,401,205
  Match 10/200: Total gas = 4,099,256, Move4 (w/ MatchRecord) = 2,385,860
  Match 25/200: Total gas = 4,094,701, Move4 (w/ MatchRecord) = 2,381,305
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,398, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,498, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 320 MatchRecords in storage

ðŸ“Š Wallet 14/20 (0x1CBd3b27...)
  Match 1/200: Total gas = 4,121,956, Move4 (w/ MatchRecord) = 2,408,560
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,094,701, Move4 (w/ MatchRecord) = 2,381,305
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,093,656, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 340 MatchRecords in storage

ðŸ“Š Wallet 15/20 (0xdF3e18d6...)
  Match 1/200: Total gas = 4,094,743, Move4 (w/ MatchRecord) = 2,381,305
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,343, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,093,656, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 340 MatchRecords in storage

ðŸ“Š Wallet 16/20 (0xcd3B766C...)
  Match 1/200: Total gas = 4,094,743, Move4 (w/ MatchRecord) = 2,381,305
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,116,398, Move4 (w/ MatchRecord) = 2,402,960
  âœ“ Wallet now has 360 MatchRecords in storage

ðŸ“Š Wallet 17/20 (0x2546BcD3...)
  Match 1/200: Total gas = 4,094,743, Move4 (w/ MatchRecord) = 2,381,305
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,093,656, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 360 MatchRecords in storage

ðŸ“Š Wallet 18/20 (0xbDA5747b...)
  Match 1/200: Total gas = 4,094,743, Move4 (w/ MatchRecord) = 2,381,305
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,043, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,116,356, Move4 (w/ MatchRecord) = 2,402,960
  Match 200/200: Total gas = 4,096,456, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 380 MatchRecords in storage

ðŸ“Š Wallet 19/20 (0xdD2FD458...)
  Match 1/200: Total gas = 4,121,956, Move4 (w/ MatchRecord) = 2,408,560
  Match 10/200: Total gas = 4,099,256, Move4 (w/ MatchRecord) = 2,385,860
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,096,456, Move4 (w/ MatchRecord) = 2,383,060
  âœ“ Wallet now has 380 MatchRecords in storage

ðŸ“Š Wallet 20/20 (0x8626f694...)
  Match 1/200: Total gas = 4,099,598, Move4 (w/ MatchRecord) = 2,388,660
  Match 10/200: Total gas = 4,102,098, Move4 (w/ MatchRecord) = 2,388,660
  Match 25/200: Total gas = 4,121,998, Move4 (w/ MatchRecord) = 2,408,560
  Match 50/200: Total gas = 4,296,001, Move4 (w/ MatchRecord) = 2,546,405
  Match 100/200: Total gas = 4,086,301, Move4 (w/ MatchRecord) = 2,372,905
  Match 200/200: Total gas = 4,093,698, Move4 (w/ MatchRecord) = 2,380,260
  âœ“ Wallet now has 400 MatchRecords in storage

âœ… Completed 4000 total matches

    âœ” Should measure gas costs across playerMatches storage growth (195797ms)

==========================================
GAS ANALYSIS REPORT
==========================================

Average Gas Costs by Match Number (across all wallets):

Match# | Enrollment | Move 1  | Move 2  | Move 3  | Move 4* | Total   | Î” from 1st
-------|------------|---------|---------|---------|---------|---------|------------
     1 |    221,192 | 373,748 | 356,617 | 365,322 | 2,411,001 | 4,126,838 |          0
    10 |    220,338 | 373,749 | 356,618 | 365,323 | 2,401,952 | 4,116,935 |     -9,903 (-0.24%)
    25 |    220,338 | 373,749 | 356,618 | 365,323 | 2,412,277 | 4,127,265 |       +427 (0.01%)
    50 |    236,583 | 373,749 | 356,618 | 365,323 | 2,546,405 | 4,295,772 |   +168,934 (4.09%)
   100 |    219,483 | 373,749 | 356,618 | 365,323 | 2,389,435 | 4,102,596 |    -24,242 (-0.59%)
   200 |    219,483 | 373,749 | 356,618 | 365,323 | 2,382,427 | 4,095,592 |    -31,246 (-0.76%)

* Move 4 includes MatchRecord creation for both players

==========================================
SUMMARY
==========================================
First match avg gas:     4,126,838
200th match avg gas:   4,095,592
Absolute increase:       -31,246 gas
Percentage increase:     -0.76%


Move 4 Analysis (MatchRecord creation):
First match Move 4:      2,411,001 gas
200th match Move 4:    2,382,427 gas
Increase:                -28,573 gas (-1.19%)


Interpretation:
âœ“ Gas costs remain stable despite storage growth
âœ“ playerMatches[address].push() pattern is efficient
âœ“ No significant degradation with unbounded array growth
âœ“ Safe to scale beyond 200 matches per player

==========================================
CONTRACT STORAGE SIZE ANALYSIS
==========================================

playerMatches Storage Breakdown:
  Total MatchRecords:        8,000
  Bytes per MatchRecord:     ~256 bytes (8 storage slots)
  Array length overhead:     640 bytes (20 wallets Ã— 32 bytes)

Total Storage Size:
  Bytes:     2,048,640 bytes
  Kilobytes: 2,000.63 KB
  Megabytes: 1.95 MB

Arbitrum L2 Storage Notes:
  â€¢ Arbitrum uses calldata compression for L1 storage
  â€¢ playerMatches data is only stored on L2 (not posted to L1)
  â€¢ Storage is cheap on L2, but grows linearly with MatchRecords
  â€¢ 200 matches = ~50.0 KB per player

Per-Player Storage:
  200 matches = 51,200 bytes
                     = 50.00 KB

Scaling Projections:
  1,000 players Ã— 200 matches:
    Storage: 97.66 MB (400,000 records)
  10,000 players Ã— 200 matches:
    Storage: 976.56 MB (4,000,000 records)
  100,000 players Ã— 200 matches:
    Storage: 9.54 GB (40,000,000 records)

==========================================


  ChessOnChain Comprehensive Escalation Tests
    EL1: Enrollment Force Start
      âœ” Should allow enrolled player to force start after enrollment timeout
      âœ” Should reject force start before timeout
      âœ” Should reject force start from non-enrolled player
      âœ” Should complete tournament immediately if only one player enrolled and force starts
    EL2: Enrollment External Claim
      âœ” Should allow external player to claim abandoned enrollment pool after EL2 delay
      âœ” Should reject claim before EL2 delay
      âœ” Should forfeit all enrolled players when pool is claimed
      âœ” Should allow new tournament to start after EL2 claim and reset
    ML1: Match Timeout Claim
      âœ” Should allow opponent to claim timeout after match timeout
      âœ” Should complete 2-player tournament after ML1 timeout claim
      âœ” Should reject timeout claim before timeout period
      âœ” Should reject timeout claim on own turn
    ML2: Advanced Player Force Eliminate
      âœ” Should allow advanced player to force eliminate stalled semi-final (70ms)
      âœ” Should reject ML2 from non-advanced player
      âœ” Should complete tournament when finalist uses ML2 on stalled semi-final (66ms)
      âœ” Should clear all player activity after ML2 tournament completion (65ms)
      âœ” Should handle ML2 on finals match (both players eliminated) (109ms)
      âœ” Should reject ML2 before escalation delay (62ms)
    ML3: External Player Replacement
      âœ” Should allow external player to replace stalled match player
      âœ” Should complete 2-player tournament after ML3 claim
      âœ” Should clear all player activity after ML3 tournament completion
      âœ” Should allow ML3 claimer to advance in tournament (57ms)
      âœ” Should reject ML3 before escalation delay
      âœ” Should reject ML3 on non-stalled match
      âœ” Should handle ML3 on finals match properly (107ms)
    Cascading Effects: Multi-Level Escalation
      âœ” Should handle ML1 -> tournament completion -> reset -> new enrollment
      âœ” Should handle ML2 in round 0 -> ML3 in finals (61ms)
      âœ” Should handle EL2 with multiple enrollments -> complete reset
      âœ” Should track forfeited amounts correctly across escalation types (59ms)
    Prize Distribution Verification Across Escalation Types
      âœ” Should distribute correct prizes for EL1 solo force start
      âœ” Should distribute correct prizes for EL2 abandoned claim
      âœ” Should distribute correct prizes for ML1 timeout victory
      âœ” Should distribute correct prizes for ML2 force eliminate victory (88ms)
      âœ” Should distribute correct prizes for ML3 replacement victory
      âœ” Should maintain zero contract balance after all escalation type completions
    Tournament Reset Verification
      âœ” Should fully reset tournament state after EL2 completion
      âœ” Should fully reset tournament state after ML2 completion (56ms)
      âœ” Should fully reset tournament state after ML3 completion

  Comprehensive Tournament Escalation Flow Tests
    8-Player Tournament with Mixed Escalation Scenarios

=== COMPREHENSIVE ESCALATION TEST ===

âœ“ 8 players enrolled, tournament started

=== ROUND 0: 4 MATCHES (8 â†’ 4 players) ===

Match 0: Normal completion
âœ“ Winner: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (now advanced player)

Match 1: Stalls â†’ L2 force elimination by advanced player
âœ“ Outsider correctly blocked from L2
âœ“ Match force eliminated via L2 by advanced player

Match 2: Stalls â†’ L3 replacement by outsider
âœ“ Advanced player correctly blocked from L3
âœ“ Outsider 0xa0Ee7A... claimed via L3

Match 3: Stalls â†’ L2 still works after L3 active (proving L2 never expires)
Waited 5 minutes (way past L3 activation)
âœ“ L2 still worked 5 minutes after L3 became active - L2 NEVER EXPIRES

=== ROUND 0 SUMMARY ===
âœ“ All 4 matches completed:
  - 1 normal win
  - 2 L2 force eliminations
  - 1 L3 replacement

=== ROUND 1: 2 MATCHES (Semi-Finals) ===

Round 1 has: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 vs 0x0000000000000000000000000000000000000000

=== TOURNAMENT COMPLETION ===
Tournament status: 1

âœ… COMPREHENSIVE ESCALATION TEST PASSED

Validated:
âœ“ Normal match completions work
âœ“ L2 (force eliminate) works for advanced players
âœ“ L2 blocked for non-advanced players
âœ“ L3 (replacement) works for outsiders
âœ“ L3 blocked for advanced players
âœ“ L2 never expires (works even after L3 active)
âœ“ Bracket advancement handles mixed completion types
      âœ” Should handle tournament with normal wins, L2 eliminations, and L3 replacements (41ms)

=== Testing Eliminated Player L3 Access ===

Match 0: Winner 0x3C44Cd..., Loser 0x709979...
âœ“ Advanced player (winner) blocked from L3
âœ“ Eliminated (non-advanced) player successfully claimed L3

âœ… Eliminated players CAN claim L3 (they're not advanced)
      âœ” Should verify eliminated player can claim L3 in their own round

=== Complex Bracket Test ===

Round 0:
  Match 0: Normal âœ“
  Match 1: Normal âœ“
  Match 2: L2 elimination âœ“
  Match 3: L3 replacement âœ“

âœ“ Round 0 complete with mixed completion types

Round 1 players: 0x3C44Cd... vs 0x15d34A...
âœ“ Bracket advanced correctly

âœ… Complex bracket with multiple escalation types handled correctly
      âœ” Should handle complex bracket with multiple escalation types

  ConnectFourOnChain Comprehensive Escalation Tests
    EL1: Enrollment Force Start
      âœ” Should allow enrolled player to force start after enrollment timeout
      âœ” Should reject force start before timeout
      âœ” Should reject force start from non-enrolled player
      âœ” Should complete tournament immediately if only one player enrolled and force starts
    EL2: Enrollment External Claim
      âœ” Should allow external player to claim abandoned enrollment pool after EL2 delay
      âœ” Should reject claim before EL2 delay
      âœ” Should forfeit all enrolled players when pool is claimed
      âœ” Should allow new tournament to start after EL2 claim and reset
    ML1: Match Timeout Claim
      âœ” Should allow opponent to claim timeout after match timeout
      âœ” Should complete 2-player tournament after ML1 timeout claim
      âœ” Should reject timeout claim before timeout period
      âœ” Should reject timeout claim on own turn
    ML2: Advanced Player Force Eliminate
      âœ” Should allow advanced player to force eliminate stalled semi-final
      âœ” Should reject ML2 from non-advanced player
      âœ” Should complete tournament when finalist uses ML2 on stalled semi-final
      âœ” Should clear all player activity after ML2 tournament completion
      âœ” Should handle ML2 on finals match (both players eliminated)
      âœ” Should reject ML2 before escalation delay
    ML3: External Player Replacement
      âœ” Should allow external player to replace stalled match player
      âœ” Should complete 2-player tournament after ML3 claim
      âœ” Should clear all player activity after ML3 tournament completion
      âœ” Should allow ML3 claimer to advance in tournament
      âœ” Should reject ML3 before escalation delay
      âœ” Should reject ML3 on non-stalled match
      âœ” Should handle ML3 on finals match properly
    Cascading Effects: Multi-Level Escalation
      âœ” Should handle ML1 -> tournament completion -> reset -> new enrollment

=== BEFORE PLAYING SEMIFINAL 1-0 ===
Player1: 0x70997970
Player2: 0x90F79bf6
Status: 1
Round 1: totalMatches=1, completedMatches=0, initialized=true

=== AFTER PLAYING SEMIFINAL 1-0 ===
Winner: 0x70997970
Status: 2
Round 1 after: totalMatches=1, completedMatches=1, initialized=true

=== FINALS 2-0 ===
Player1: 0x70997970
Player2: 0x9965507D
Status: 1
Round 2: totalMatches=1, completedMatches=0, initialized=true
      âœ” Should handle ML2 in round 0 -> ML3 in finals (53ms)
      âœ” Should handle EL2 with multiple enrollments -> complete reset
      âœ” Should track forfeited amounts correctly across escalation types
    Prize Distribution Verification Across Escalation Types
      âœ” Should distribute correct prizes for EL1 solo force start
      âœ” Should distribute correct prizes for EL2 abandoned claim
      âœ” Should distribute correct prizes for ML1 timeout victory
      âœ” Should distribute correct prizes for ML2 force eliminate victory
      âœ” Should distribute correct prizes for ML3 replacement victory
      âœ” Should maintain protocol and owner fees after all escalation type completions
    Tournament Reset Verification
      âœ” Should fully reset tournament state after EL2 completion
      âœ” Should fully reset tournament state after ML2 completion
      âœ” Should fully reset tournament state after ML3 completion

  TicTacChain (ETour Protocol) Tests
    Deployment
      âœ” Should deploy successfully
      âœ” Should have correct owner
      âœ” Should have 3 tiers configured
    Tournament Enrollment
      âœ” Should enroll players and auto-start when full (2-player)
      âœ” Should split entry fees correctly (90% prize pool, 10% owner)
      âœ” Should reject incorrect entry fee
      âœ” Should reject duplicate enrollment
      âœ” Should reject invalid tier
    Tournament Logic
      âœ” Should initialize round with correct match count (8-player = 4 matches)
      âœ” Should handle force start after enrollment timeout
    Game Play
      âœ” Should allow players to make moves
      âœ” Should switch turns after each move
      âœ” Should reject move when not your turn
      âœ” Should reject move to occupied cell
      âœ” Should reject invalid cell index
      âœ” Should reject move from non-player
    Win Detection
      âœ” Should detect horizontal win (top row)
      âœ” Should detect vertical win (left column)
      âœ” Should detect diagonal win (0, 4, 8)
      âœ” Should detect draw when board is full with no winner
    Tournament Completion
      âœ” Should complete 2-player tournament and distribute prizes
    Timeout Functions
      âœ” Should allow timeout claim after timeout period
      âœ” Should reject early timeout claim
      âœ” Should reject timeout claim on your own turn
    View Functions
      âœ” Should return match data correctly
    Gas Optimization
      Gas used for enrollment: 253905
      âœ” Should have reasonable gas costs for enrollment
      Gas used for move: 103527
      âœ” Should have reasonable gas costs for making a move
    Abandoned Enrollment Pool Claims
      âœ” Should reject claim before escalation2 window
      âœ” Should allow external player to claim abandoned pool after escalation2
      âœ” Should forfeit all enrolled players when pool is claimed
      âœ” Should reject claim when no enrollment pool exists
    Force Start Edge Cases
      âœ” Should reject force start from non-enrolled player
      âœ” Should handle single player force start with immediate win
    View Functions Coverage
      âœ” Should return correct tournament info via getTournamentInfo
      âœ” Should return round info correctly
      âœ” Should return player stats correctly
      âœ” Should track player earnings on leaderboard - winner has positive, loser negative
      âœ” Should return full leaderboard with all players
    Prize Distribution
      âœ” Should distribute prizes correctly (2-player)
      âœ” Should handle draw finals with co-winners
    8-Player Tournament Full Flow
      âœ” Should complete full 8-player bracket tournament (38ms)
    Timeout Escalation Levels
      âœ” Should track timeout escalation timestamps
    Invalid Operations
      âœ” Should reject invalid instance ID
      âœ” Should reject enrollment in full tournament
      âœ” Should reject force start when tournament already in progress
    Tournament Reset and Cleanup
      âœ” Should properly reset all state after tournament completion
      âœ” Should allow re-enrollment after tournament reset
    Entry Fee Distribution
      âœ” Should correctly split fees (90% pool, 7.5% owner, 2.5% protocol)
    Enrollment Timeout State
      âœ” Should initialize enrollment timeout timestamps on first enrollment
      âœ” Should track forfeit pool during enrollment
    All-Draw Round Scenarios
      âœ” Should handle finals draw with co-winners
      âœ” Should handle 8-player tournament with multiple draws in first round
    Advanced Tournament Progression
      âœ” Should handle walkover when odd number of players in round

========== FIRST TOURNAMENT ==========
First Tournament Finalists: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC 0x90F79bf6EB2c4f870365E785982E1f101E93b906
First Tournament Winner: 0x90F79bf6EB2c4f870365E785982E1f101E93b906

========== SECOND TOURNAMENT ==========
Second Tournament Semifinal 0 Players: 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc 0x976EA74026E726554dB657fA54763abd0C3a0aa9
Second Tournament Semifinal 0 Winner: 0x976EA74026E726554dB657fA54763abd0C3a0aa9
Second Tournament Semifinal 1 Winner: 0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f

Second Tournament Finals after both semifinals:
  player1: 0x976EA74026E726554dB657fA54763abd0C3a0aa9
  player2: 0x23618e81E3f5cdF7f54C3d65f7FBc0aBf5B21E8f
  status: 1n
      âœ” Should NOT have stale finals data from previous tournament
    Match Timeout State Tracking
      âœ” Should update lastMoveTime after each move
      âœ” Should allow timeout claim after move timeout elapses
    Complete Tournament Flow with Mixed Results
      âœ” Should complete 8-player tournament with wins and draws (39ms)
    Escalation Victory and Prize Distribution
      âœ” Should award full prize pool when timeout claim wins 2-player tournament
      âœ” Should track forfeited amounts for eliminated players on escalation
      âœ” Should correctly distribute prize pool after abandoned enrollment claim
    playerPrizes and Leaderboard Consistency
      âœ” Should have playerPrizes equal to prize amount for winner in 2-player tournament
      âœ” Should have leaderboard earnings equal to (playerPrizes - entryFee) for winner
      âœ” Should have consistent playerPrizes and leaderboard for 8-player tournament (51ms)
      âœ” Should have consistent playerPrizes and leaderboard after timeout victory
      âœ” Should have consistent playerPrizes and leaderboard for draw finals
    Force Start with Odd Players
      âœ” Should handle force start with 3 players (requires walkover)
      âœ” Should handle force start with 5 players
      âœ” Should handle force start with 7 players
      âœ” Should complete tournament started with odd players
    All-Draw Round Scenarios
      âœ” Should handle all semi-finals drawing - all 4 players share prize
      âœ” Should complete tournament when finals also draws (co-winners)
    Prize Distribution Edge Cases
      âœ” Should handle prize distribution with odd total (rounding)
      âœ” Should distribute prizes correctly in 8-player tournament (40ms)
    Multi-Tournament Player Scenarios
      âœ” Should allow same player to enroll in different instances
      âœ” Should allow same player in different tiers
      âœ” Should correctly update earnings across multiple tournaments
    Instance and Tier Boundary Cases
      âœ” Should reject enrollment at max instanceId
      âœ” Should reject enrollment in non-existent tier
      âœ” Should handle enrollment at exact tier boundaries
    getMatch Cache Fallback - Two-Person Tournament
      âœ” Should clear finals immediately after tournament completion (ARCHITECTURE CHANGE)
      âœ” Should return empty data for non-existent match
      âœ” Should return active match data when match is still in progress
    COMPREHENSIVE: Cross-Tournament Data Isolation

========== FIRST TOURNAMENT: 3 PLAYERS - TESTING DRAW & ML2 ==========
Tournament 1 started with 3 players
Round 0 has 1 matches

Match 0: Testing DRAW
  Result - status: 0, isDraw: false
Tournament 1 final status: 0

Tournament 1 Prize Distribution:
  Player1: 1170000000000000
  Player2: 1170000000000000
  Player3: 1170000000000000

First Tournament match data after completion:
  player1: 0x0000000000000000000000000000000000000000

========== SECOND TOURNAMENT: 7 PLAYERS - TEST WIN/DRAW/ML2/ML3 ==========
Tournament 2 started with 7 players

Second Tournament Initial State:
  QF0 player1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  QF0 status: 1

=== Testing Different Match Endings ===
Total QF matches: 3

Match 0: Testing NORMAL WIN
  âœ“ Winner: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC

Match 1: Testing DRAW
  âœ“ isDraw: true

Match 2: Normal WIN

=== Completing Remaining Matches ===
  Playing R1M0
  Playing R2M0
  âœ“ Tournament completed!

Tournament 2 final status: 0

========== DATA ISOLATION VERIFICATION ==========
âœ“ Match data properly cleared after completion

========== PRIZE DISTRIBUTION ==========

========== EARNINGS VERIFICATION ==========
0x70997970C51812dc3A010C7d01b50e0d17dc79C8 (returning): total=2340000000000000, T2 delta=1170000000000000
0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC (returning): total=2340000000000000, T2 delta=1170000000000000
0x90F79bf6EB2c4f870365E785982E1f101E93b906 (returning): total=2340000000000000, T2 delta=1170000000000000
0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65 (new): total=0, T2 delta=0
0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc (new): total=8190000000000000, T2 delta=8190000000000000
0x976EA74026E726554dB657fA54763abd0C3a0aa9 (new): total=0, T2 delta=0
0x14dC79964da2C08b23698B3D3cc7Ca32193d9955 (new): total=0, T2 delta=0

Total T2 prize pool: 8190000000000000 wei

========== THIRD TOURNAMENT: 8 PLAYERS - ML2 & ML3 FOCUS ==========
Tournament 3 started with full 8 players

=== Quarterfinals: Testing ML2 & ML3 ===

QF Match 0: Normal WIN
  âœ“ Completed normally

QF Match 1: ML2 TIMEOUT
  Players: 0x90F79bf6... vs 0x15d34AAf...
  Move made, now waiting for timeout...
  âœ“ ML2 claimed by non-timeout player 0x15d34AAf...
  âœ“ Winner: 0x15d34AAf... (timed out player lost)

QF Match 2: Normal WIN
  âœ“ Completed normally

QF Match 3: Normal WIN
  âœ“ Completed normally

=== Semifinals: Normal Wins ===

SF Match 0: Normal WIN
  âœ“ Completed normally

SF Match 1: Normal WIN
  âœ“ Completed normally

=== Finals: Normal Win ===

Finals Match:
  Finalists: 0x15d34AAf... vs 0x14dC7996...
  âœ“ Finals completed normally
  âœ“ Tournament winner: 0x15d34AAf...

âœ“ Tournament 3 completed and reset

=== Tournament 3 Prize Verification ===
  0x70997970... earned 1170000000000000 wei in T3
  0x3C44CdDd... earned 1170000000000000 wei in T3
  0x90F79bf6... earned 1170000000000000 wei in T3
  0x15d34AAf... earned 9360000000000000 wei in T3
  0x9965507D... earned 8190000000000000 wei in T3
  Total distributed: 21060000000000000 wei
  Expected pool: 9360000000000000 wei
âœ“ Prize distribution verified (at least some prizes distributed)
âœ“ Finals match data cleared

========== RECENT MATCHES VERIFICATION ==========
Verifying recentMatches entries for all players across all tournaments...

Tournament 1 Players:
  0x70997970... has 3 recent matches
  0x3C44CdDd... has 5 recent matches
  0x90F79bf6... has 3 recent matches

Tournament 2 Players:
  0x70997970... (returning) has 3 recent matches
  0x3C44CdDd... (returning) has 5 recent matches
  0x90F79bf6... (returning) has 3 recent matches
  0x15d34AAf... (new) has 4 recent matches
  0x9965507D... (new) has 3 recent matches
  0x976EA740... (new) has 3 recent matches
  0x14dC7996... (new) has 4 recent matches

Tournament 3 Players:
  0x70997970... (all 3 tournaments) has 3 recent matches
  0x3C44CdDd... (all 3 tournaments) has 5 recent matches
  0x90F79bf6... (all 3 tournaments) has 3 recent matches
  0x15d34AAf... (T2 & T3) has 4 recent matches
  0x9965507D... (T2 & T3) has 3 recent matches
  0x976EA740... (T2 & T3) has 3 recent matches
  0x14dC7996... (T2 & T3) has 4 recent matches
  0x23618e81... (T3 only) has 1 recent matches

âœ“ All players have appropriate recentMatches entries
âœ“ recentMatches data persists correctly across tournaments
âœ“ Match entry data structures are valid

========== COMPREHENSIVE TEST SUMMARY ==========
âœ“ Tournament 1: 3 players with draw scenario
âœ“ Tournament 2: 7 players (WIN, DRAW scenarios)
âœ“ Tournament 3: 8 players (ML2 timeout tested)
  â€¢ QF: 1 normal win, 1 ML2 timeout, 2 normal wins
  â€¢ SF: 2 normal wins
  â€¢ Finals: Normal win (ML3 testing skipped for now)
âœ“ Match-ending scenarios tested: WIN, DRAW, ML2 (ML3 to be tested later)
âœ“ Match data properly isolated across all 3 tournaments
âœ“ Prize distribution verified for all tournaments
âœ“ Earnings accumulation working correctly
âœ“ Data cleanup confirmed after each tournament
âœ“ RecentMatches entries verified for all players

ðŸŽ‰ ALL COMPREHENSIVE CHECKS PASSED!
      âœ” Should completely isolate data across tournaments with walkovers, draws, ML2/ML3, and prize distribution (145ms)

  Transfer Event Tests
    TicTacToe Reward Transfer Event
      âœ” Should emit Transfer event with correct parameters for winner
      âœ” Should emit Transfer events for all winners in all-draw scenario
    Chess Transfer Event
      - Should emit Transfer event with gameName='Chess Reward' for winner
    ConnectFour Reward Transfer Event
      âœ” Should emit Transfer event with gameName='ConnectFour Reward' for winner
    Transfer Event Structure
      âœ” Should have correct indexed parameters for MetaMask filtering
      âœ” Should emit prize value matching actual prize distribution
    Transfer Event - No Emission on Failure
      âœ” Should not emit Transfer event when prize transfer fails

  Enrollment Escalation - TournamentRecord Validation
    EL1: Solo Enrollment Force Start
      âœ” Should create TournamentRecord with SoloEnrollForceStart completion reason
      âœ” Should handle EL1 correctly for different tier sizes
      âœ” Should update player earnings correctly for EL1
    EL2: Abandoned Tournament Claim
      âœ” Should create TournamentRecord with AbandonedTournamentClaimed completion reason
      âœ” Should handle EL2 with multiple abandoned players
      âœ” Should update claimer earnings correctly for EL2
      âœ” Should not allow EL2 claim before escalation2Start
    EL1 vs EL2 Comparison
      âœ” Should create different completion reasons for EL1 vs EL2
    recentInstances Persistence
      âœ” Should persist TournamentRecord across multiple tournament instances
      âœ” Should maintain separate records for different tiers and instances
    Edge Cases
      âœ” Should handle recentInstances query for never-completed tournament
      âœ” Should preserve TournamentRecord after subsequent enrollments

  Enrollment Window Reset
    Test 1: Successful Reset
      âœ” Should allow solo player to reset enrollment window after expiry
    Test 2: Reject if Tournament Not Enrolling
      âœ” Should reject reset if tournament not enrolling
    Test 3: Reject if Multiple Players Enrolled
      âœ” Should reject reset if multiple players enrolled
    Test 4: Reject if Caller Not Enrolled
      âœ” Should reject reset if caller not enrolled
    Test 5: Reject if Window Not Expired
      âœ” Should reject reset if enrollment window not expired
    Test 6: Reset Still Works After Escalation Level 2
      âœ” Should allow reset even after escalation level 2 reached
    Test 7: Second Player Can Enroll After Reset
      âœ” Should allow second player to enroll after reset
    Test 8: Multiple Resets Allowed
      âœ” Should allow player to reset multiple times
    Test 9: canResetEnrollmentWindow View Function Accuracy
      âœ” Should accurately report reset eligibility via view function
    Test 10: Reset Preserves forfeitPool
      âœ” Should preserve forfeitPool amount after reset
    Test 11: Reset Updates Escalation Timestamps
      âœ” Should update escalation timestamps correctly on reset
    Test 12: Cannot Reset After Force Start
      âœ” Should not allow reset after force starting tournament

  Escalation View Functions Tests
    isMatchEscL2Available
      âœ” Should return false when tournament status is not InProgress
      âœ” Should return false when match is not active
      âœ” Should return false when current player has not timed out
      âœ” Should return false when timeout occurred but L2 delay has not passed
      âœ” Should return true when timeout occurred and L2 delay has passed (not marked stalled)
      âœ” Should return false exactly at the L2 delay boundary (edge case)
    isMatchEscL3Available
      âœ” Should return false when tournament status is not InProgress
      âœ” Should return false when match is not active
      âœ” Should return false when current player has not timed out
      âœ” Should return false when timeout occurred but L3 delay has not passed
      âœ” Should return true when timeout occurred and L3 delay has passed (not marked stalled)
      âœ” Should return false exactly at the L3 delay boundary (edge case)
      âœ” Should progress from L2 -> L3 availability over time
    Cross-level consistency checks
      âœ” Should never have L3 available without L2 being available
    Match completion invalidation
      âœ” Should return false for all escalation levels after match is completed

  Finals Data Persistence Bug (TDD)
    Scenario 1: Finals Never Completed (InProgress)

=== TEST: Incomplete Finals Data Persistence ===

CYCLE 1: Creating tournament...
Finals status: 1 (1=InProgress)
âœ“ Finals completed, tournament reset
âœ“ Tournament status: 0 (0=Enrolling)

NEW CYCLE: Verifying immediate match data clearing...
âœ“ FINALS CLEARED IMMEDIATELY ON RESET
  - Security gap closed
  - Historical data available via events
âœ“ Player3 enrolled in new cycle
âœ“ Finals remain cleared (as expected)

=== TEST COMPLETE ===

      âœ” Should clear incomplete finals match data on first enrollment in new cycle
    Scenario 2: Double-Elimination Finals (winner = address(0))

=== TEST: Double-Elimination Finals Data Persistence ===

CYCLE 1: Creating 4-player tournament...
âœ“ Semi-final 0 complete: winner=0x70997970...
âœ“ Semi-final 1 complete: winner=0x15d34AAf...
âœ“ Finals created: 0x70997970... vs 0x15d34AAf...
Executing ML2 on finals...
âœ“ ML2 executed - tournament completed and reset
âœ“ Tournament status: 0 (0=Enrolling)

NEW CYCLE: Verifying immediate match data clearing...
âœ“ DOUBLE-ELIMINATION FINALS CLEARED IMMEDIATELY ON RESET
  - winner=0x0 case handled properly
  - Security gap closed
âœ“ First enrollment in new cycle
âœ“ Finals remain cleared (as expected)

=== TEST COMPLETE ===

      âœ” Should clear double-elimination finals on first enrollment in new cycle
    Scenario 3: Exploit Attempt After Status Check Fix

=== TEST: ML3 Exploit Prevention with Status Check ===

CYCLE 1: Completing tournament...
âœ“ Tournament completed normally
âœ“ Tournament reset: status=0 (0=Enrolling)

ATTACKER: Attempting ML3 on stale finals...
âœ“ EXPLOIT BLOCKED: Tournament status check prevented ML3
  - Error: VM Exception while processing transaction: reverted with reason string 'Tournament not in progress'

=== TEST COMPLETE ===

      âœ” Should prevent ML3 claim on stale finals even if not cleared

  TicTacChain - Constructor Initialization
    âœ” Should have 3 tiers initialized after deployment
    âœ” Should have valid tier configurations after deployment

  L2/L3 Ordering Test
Testing L2/L3 ordering:
- Match time: 120 seconds
- L2 delay: 120 seconds (starts after timeout)
- L3 delay: 240 seconds (starts after timeout)

=== BEFORE L2 delay completes ===
âœ“ L3 claim correctly blocked before L2 delay passes

=== AFTER L3 delay completes ===
âœ“ L3 claim succeeds after L3 delay passes
    âœ” Should ensure L3 escalation respects L2 -> L3 ordering

  ML2 (Force Eliminate) Comprehensive Tests
    Advanced Player Detection

=== TEST: Advanced Player Detection ===

Enrolling 4 players...
âœ“ 4 players enrolled
Match 0: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 vs 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Match 1: 0x90F79bf6EB2c4f870365E785982E1f101E93b906 vs 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65

Completing Match 0...
Match 0 status: 2
Match 0 winner: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Match 0 isDraw: false
âœ“ Match 0 complete - Winner: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC

Checking finals assignment...
Finals player1: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Finals player2: 0x0000000000000000000000000000000000000000
Finals status: 0
âœ“ Winner is in finals

Checking isPlayerInAdvancedRound for round 0...
Winner 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC isPlayerInAdvancedRound: true
Loser 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 isPlayerInAdvancedRound: false
âœ“ Advanced player detection working correctly
      âœ” Should correctly identify player who won their match as advanced

=== TEST: Advanced Player Detection After Caching ===

Match 0 winner: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Match 0 isCached: false
isPlayerInAdvancedRound (cached=false): true
âœ“ Advanced player detection works with cached matches
      âœ” Should detect advanced player even after match is cached
    ML2 Execution

=== TEST: ML2 Force Eliminate ===

Advanced player: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8

Stalling Match 1...
âœ“ Match 1 stalled

Advancing time for ML2...

Verifying ML2 eligibility...
Advanced player 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 isPlayerInAdvancedRound: true

Executing ML2 force eliminate...
âœ“ ML2 executed successfully
âœ“ Match 1 double-eliminated
      âœ” Should allow advanced player to force eliminate stalled match

=== TEST: ML2 Rejection for Non-Advanced ===


Attempting ML2 with non-advanced player...
âœ“ Non-advanced player correctly rejected
      âœ” Should reject ML2 from non-advanced player
    Tournament Completion via ML2

=== TEST: ML2 Tournament Completion (Finalist triggers ML2 on semi) ===

âœ“ 4 players enrolled
âœ“ Match 0 complete, finalist: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
âœ“ Finalist assigned to finals
âœ“ Match 1 (semi-final) stalled

Finalist using ML2 to eliminate stalled semi-final...
âœ“ ML2 executed
âœ“ Tournament completed and reset
âœ“ Finalist received prize: 0.00252 ETH

=== TEST COMPLETE ===

      âœ” Should complete tournament when finalist uses ML2 on stalled semi-final

=== TEST: ML2 on Finals (Double Elimination) ===

âœ“ 2 players enrolled (immediate finals)
âœ“ Finals match stalled

(Switching to 4-player scenario for advanced player requirement)
âœ“ Both semi-finals complete
âœ“ Finals stalled

Using ML2 on finals (will eliminate both players)...
âœ“ ML2 executed on finals
âœ“ Tournament completed and reset

=== TEST COMPLETE ===

      âœ” Should complete tournament when ML2 is used on finals (both eliminated) (85ms)
    Escalation Timing Issues

=== TEST: Escalation Timer Reset on Move ===

âœ“ 4 players enrolled
âœ“ Advanced player: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
âœ“ Match 1 - first move made

Waiting for timeout (but not ML2 delay)...
âœ“ Match 1 - second move made (should clear escalation state)

Trying ML2 immediately after move (should fail)...
âœ“ ML2 correctly rejected - escalation state was cleared

Waiting for timeout + ML2 delay from NEW move...
âœ“ ML2 successful after proper delay

=== TEST COMPLETE ===

      âœ” Should reset ML2 timer when a move is made after timeout
    Edge Cases

=== TEST: ML2 with Walkover Advancement ===

(Test scenario: Player advances via auto-walkover, then uses ML2)
âš  Test skipped - requires walkover scenario setup
      âœ” Should handle ML2 when advanced player won via walkover

  ML2 Exact User Scenario

=== EXACT USER SCENARIO TEST ===

Step 1: Enrolling 4 players (A, B, C, D)...
Match 0 (semi): 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 vs 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Match 1 (semi): 0x90F79bf6EB2c4f870365E785982E1f101E93b906 vs 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65
âœ“ Tournament started

Step 2: Playing A vs B (A should win)...
Winner of match 0: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
âœ“ A won and advanced to finals
Finals: player1=0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC, player2=0x0000000000000000000000000000000000000000

Step 3: C vs D stalling (one move then timeout)...
âœ“ One move made in C vs D, now waiting for stall...
âœ“ Time advanced past ML2 threshold

Step 4: State BEFORE ML2 trigger:
  Tournament status: 1 (0=Enrolling, 1=InProgress, 2=Completed)
  Enrolled count: 4
  Prize pool: 0.00252 ETH
  Is A advanced? true

Step 5: A triggering ML2 on C vs D...
âœ“ ML2 transaction successful

Step 6: State AFTER ML2 trigger:
  Tournament status: 0 (0=Enrolling, 1=InProgress, 2=Completed)
  Enrolled count: 0
  Prize pool: 0.0 ETH
  Winner: 0x0000000000000000000000000000000000000000

Step 7: Verifying tournament completion...
âœ“ Tournament properly reset

Step 8: Verifying prize distribution...
  A's prize: 0.00252 ETH
âœ“ Prize distributed to A

=== TEST COMPLETE âœ… ===

    âœ” EXACT SCENARIO: A beats B, C vs D stalls, A triggers ML2 â†’ should complete tournament

  ML3 Finals Match Completion Bug Fix
    ML3 Claim on Finals Match

=== ML3 FINALS COMPLETION TEST ===

Step 1: Enrolling 2 players...
âœ“ Tournament started with 2 players (immediate finals)

Step 2: Stalling finals match...
âœ“ 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC made first move, now waiting for timeout...

Step 3: Advancing time past ML3 threshold...
âœ“ Time advanced past ML3 threshold
Prize pool before ML3 claim: 0.00054 ETH

Step 4: External player claiming ML3 on finals match...
âœ“ ML3 claim transaction successful

Step 5: Verifying tournament completion...
âœ“ Tournament status is Enrolling (reset completed)
âœ“ Winner cleared after reset
âœ“ Enrolled count reset to 0
âœ“ Prize pool reset to 0

Step 6: Verifying prize distribution...
âœ“ Outsider received prize: 0.00054 ETH
Prize accuracy: 100% (difference: 0.0 ETH)

Step 9: Verifying new tournament can start...
âœ“ New player can enroll in reset tournament

=== TEST COMPLETE ===

      âœ” Should properly complete tournament, distribute prizes, and reset when ML3 is claimed on finals

=== ADVANCED PLAYER CHECK TEST ===

Step 1: Enrolling 4 players...
âœ“ Tournament started with 4 players
  Match 0: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 vs 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
  Match 1: 0x90F79bf6EB2c4f870365E785982E1f101E93b906 vs 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65

Step 2: Completing Match 0 (A vs B)...
âœ“ Match 0 complete, winner: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC

Step 3: Checking finals match...
  Finals player1: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
  Finals player2: 0x0000000000000000000000000000000000000000
âœ“ Winner 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC is assigned to finals

Step 4: Stalling Match 1 (C vs D)...
âœ“ Match 1 stalled after first move

Step 5: Checking isPlayerInAdvancedRound...
âœ“ Winner 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC correctly identified as advanced player
âœ“ Loser 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 correctly NOT identified as advanced

=== TEST COMPLETE ===

      âœ” Should correctly identify advanced player for ML2 eligibility

=== ML2 FINALS COMPLETION TEST ===

Step 1: Enrolling 4 players...
âœ“ Tournament started with 4 players

Step 2: Completing semi-finals matches...
âœ“ Semi-final 0 complete, winner: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
âœ“ Semi-final 1 complete

Step 3: Stalling finals match...
âœ“ Finals match stalled after first move

Step 4: Advancing time for ML2 and forcing elimination...
âœ“ Time advanced past ML2 threshold
Prize pool before ML2: 0.00252 ETH
âœ“ ML2 force elimination successful

Step 5: Verifying tournament completion...
âœ“ Tournament properly reset after ML2 on finals

=== TEST COMPLETE ===

      âœ” Should also handle ML2 (force eliminate) on finals match properly

  Match-Level Escalation (Anti-Stalling) Tests
    Level 1: Normal Timeout Claim (Baseline)
      âœ” Should allow opponent to claim timeout when player runs out of time
      âœ” Should reflect ML1 timeout as CompletionReason.Timeout in recentInstances
    Level 2: Advanced Player Force Elimination
      âœ” Should mark match as stalled when player runs out of time
      âœ” Should allow advanced player to force eliminate stalled match after escalation window
      âœ” Should reject force elimination from non-advanced player
      âœ” Should reject force elimination before escalation window
    Level 3: External Player Replacement
      âœ” Should allow external player to claim match slot after Level 3 escalation window
      âœ” Should reject replacement claim before Level 3 window
      âœ” Should reject replacement claim on non-stalled match
    Escalation Integration with Tournament Progression
Round 0 after enrollment: { initialized: true, totalMatches: 2n, completedMatches: 0n }
Round 0 after Match 1 completes: { totalMatches: 2n, completedMatches: 1n }
Tournament status after Match 1: 1n
      âœ” Should allow tournament to progress after force elimination
      âœ” Should allow replacement player to advance in tournament
    Edge Cases and Security
      âœ” Should not allow claiming already completed match
      âœ” Should clear escalation state after match completion

  Prize Distribution Failure Fallback
    Prize Send Failure - Solo Winner
      âœ” Should fallback to accumulatedProtocolShare when solo winner rejects prize
    Prize Send Failure - Tournament Winner
      âœ” Should fallback to accumulatedProtocolShare when winner address rejects
    Accumulated Protocol Share Tracking
      âœ” Should track accumulated protocol share from failed distributions
    Tournament Completion with Failed Prize
      âœ” Should complete tournament even if prize distribution fails
    Multi-Player Tournament with Failed Prizes
      âœ” Should handle multiple prize distributions in 4-player tournament (38ms)
    Contract Balance Accounting
      âœ” Should maintain correct contract balance with accumulated fees

  Protocol Raffle System
    getRaffleInfo() View Function
      âœ” Should return correct raffle info when below threshold
      âœ” Should return correct raffle info when at threshold with no players
      - Should count enrolled players correctly (DEPRECATED - eligiblePlayerCount calculation changed)
      âœ” Should return raffleIndex starting at 0
      âœ” Should return correct threshold from _getRaffleThreshold()
      âœ” Should return correct reserve from _getRaffleReserve()
    Access Control
      âœ” Should reject non-enrolled players when threshold not met
      âœ” Should reject non-enrolled players even when threshold met
      âœ” Should allow enrolled players to trigger raffle (Enrolling status)
      âœ” Should allow enrolled players to trigger raffle (InProgress status)
      âœ” Should reject players only enrolled in Completed tournaments
    Raffle Mechanics (Integration with Failed Prizes)
      âœ” Should accumulate protocol share from failed prize distributions
      - Should handle multiple enrollment counts correctly (DEPRECATED - eligiblePlayerCount calculation changed)
    Raffle Distribution
      âœ” Should calculate 5% owner / 90% winner correctly
      âœ” Should maintain 5% reserve after raffle
    Edge Cases
      âœ” Should handle exactly 3 ETH threshold
      âœ” Should handle large amounts (10 ETH)
      - Should handle single enrolled player (100% chance) (DEPRECATED - eligiblePlayerCount calculation changed)
      - Should handle player enrolled in many tournaments (DEPRECATED - eligiblePlayerCount calculation changed)
    Security Considerations
      âœ” Should use nonReentrant modifier on executeProtocolRaffle
      âœ” Should follow CEI pattern (Checks-Effects-Interactions)
      âœ” Should handle failed owner send
      âœ” Should handle failed winner send
    Randomness Quality
      âœ” Should use block.prevrandao for randomness
      âœ” Should produce different results with different block data
    Gas Efficiency
      âœ” Should handle reasonable number of enrolled players
      âœ” Should document max capacity (1000 players)
    Integration with Prize Distribution
      âœ” Should accumulate protocol share from entry fees (2.5%)
      âœ” Should accumulate from both protocol fees AND failed prize distributions

  Raffle Results Storage - Historic Data Validation
    Single Raffle Execution Storage
      - Should store complete raffle result data after execution
      - Should store different winner when randomness changes
      - Should handle weighted participants correctly when player enrolled in multiple tournaments
    Multiple Consecutive Raffles Storage
      - Should store separate results for 3 consecutive raffles with correct data
      - Should maintain independent storage for each raffle index
      - Should correctly track progressive threshold increases across raffles
    Edge Cases and Data Integrity
      - Should handle raffle with single participant
      - Should ensure participants and weights arrays have same length
      - Should preserve exact ETH amounts without rounding errors
      - Should query non-existent raffle index safely
    Storage Gas Costs
      - Should document gas cost for storing raffle results
      - Should handle storage for raffle with many participants

  Basic Deployment Test
Deploying modules...
Core deployed
Matches deployed
Prizes deployed
Raffle deployed
Escalation deployed

Deploying TicTacChain...
TicTacChain deployed
Tier count: 3
    âœ” Should deploy all contracts successfully (119ms)

  Test Delegatecall Direct
TicTacChain deployed and initialized

âœ… Delegatecall via enrollment succeeded!
    âœ” Should test delegatecall behavior via enrollment

  Test ETour_Storage Access
âœ… tierCount: 3
    âœ” Should access tierCount from ETour_Storage
âœ… owner: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
    âœ” Should access owner from ETour_Storage
âœ… Contract initialized with 3 tiers
    âœ” Should verify contract is initialized by checking tiers

  Enrollment Debug Test
Contract deployed successfully
Tier count: 3
Attempting to enroll with fee: 300000000000000
Enrollment successful!
    âœ” Should enroll player in tier 0

  Test Player Activity Counts

âœ… Game initialized
âœ… Initial enrollment state: false
âœ… After enrollment: true
    âœ” Should verify enrollment status works (replaces activity counts)

  Test Simple Tracking

âœ… Game deployed and initialized
Game address: 0x74303EC0fC495cb08FFA08783De17591b4e7B063
âœ… Player enrolled and tracking works
    âœ” Should test that player tracking storage exists in game contract (144ms)

  TicTacChain Enrollment Quick Test

TicTacChain: 0xaB95e2145fDDc182a2AF4A0a3eecD2972Ec9b52b
Initialized

âœ… Player1 enrolled! Gas: 253893
    âœ” Should enroll player1
âœ… Player2 enrolled! Gas: 351960
    âœ” Should enroll player2 and start

  Time Bank System (Chess Clock) Tests
    Time Bank Initialization
      âœ” Should initialize both players with configured match time at match start
    Time Bank Mechanics
      âœ” Should deduct time from player's bank after making a move
      âœ” Should allow multiple moves with cumulative time deduction
      âœ” Should NOT allow opponent to claim timeout before time runs out
      âœ” Should allow opponent to claim timeout after time runs out
      âœ” Should NOT allow player to claim timeout on their own turn
      âœ” Should accurately track time after turn switches
      âœ” Should handle time bank reaching exactly zero
      âœ” Should NOT allow timeout claim while opponent still has time
    Time Bank Edge Cases
      âœ” Should handle rapid successive moves without time manipulation
      âœ” Should correctly handle match completion before timeout
    Tournament Integration with Time Banks
      âœ” Should handle 4-player tournament with time banks properly
      âœ” Should allow timeout claim in semifinal and winner advances to finals
    Time Increment (Future Feature)
      âœ” Should have zero increment by default

  Tournament Reset - Basic 4-Player Tournaments
    Basic Tournament Reset with Normal Gameplay

=== FIRST TOURNAMENT (2 players, force start) ===
Tournament 1 started with 2 players
Round 0: 1 match(es)
Match 0-0: 0x3C44 vs 0x7099
0x3C44 wins match 0-0
âœ“ Tournament 1 completed and reset

=== SECOND TOURNAMENT (3 players, force start) ===
Tournament 2 started with 3 players
Debug - Round 0 initialized: true, totalMatches: 1

Round 0: 1 matches
Match 0-0: 0x9965 vs 0x90F7
0x9965 wins match 0-0
Tournament status still InProgress after round 0
Next round (1) - initialized: true, totalMatches: 1

Round 1: 1 matches
Match 1-0: 0x15d3 vs 0x9965
0x15d3 wins match 1-0
Tournament status still InProgress after round 1
Next round (2) - initialized: false, totalMatches: 0

âœ“ Second tournament completed and reset successfully
âœ“ All 2 tournaments validated: 2 players, 3 players
âœ“ Round data properly cleared after reset

âœ… HTML report updated: test-report-2026.html
      âœ” Should handle 2 consecutive 4-player tournaments with 2 and 3 players respectively

  Tournament Reset and Enrollment Edge Cases
    Tournament Reset State Management
      âœ” Should allow enrollment after tournament completes and resets
      âœ” Should clear all round data on tournament reset
      âœ” Should clear player enrollment status on reset
    Enrollment State Protection
      âœ” Should reject enrollment during active tournament
      âœ” Should reject duplicate enrollment in same tournament
      âœ” Should allow same player in different instances
      âœ” Should allow same player in different tiers
    Prize Pool Reset
      âœ” Should reset prize pool to zero after distribution
      âœ” Should accumulate new prize pool for second tournament
    CRITICAL BUG: Match Data Persistence Across Tournaments

=== FIRST TOURNAMENT (4 players, force start) ===

Round 0: 2 matches
Match 0-0: 0x7099 vs 0x3C44
0x7099 wins match 0-0
Match 0-1: 0x90F7 vs 0x15d3
0x90F7 wins match 0-1

Round 1: 1 matches
Match 1-0: 0x7099 vs 0x90F7
0x7099 wins match 1-0

=== SECOND TOURNAMENT (7 players with Draw and ML2) ===
Round 0: 3 matches initialized
Match 0-0: 0x3C44 vs 0x14dC
Match 0-0 ended in DRAW
Match 0-1: 0x15d3 vs 0x90F7
0x15d3 wins match 0-1
Match 0-2: 0x976E vs 0x9965
0x976E wins match 0-2

=== Round 1 (Semifinals) ===
Round 1: 1 matches
Match 1-0 will be stalled for ML2: 0x15d3 vs 0x976E
One move made, now stalling...
Advanced player 0x15d3 using ML2 to force eliminate
âœ“ ML2 executed - both players eliminated
Tournament 2 status: 0

=== THIRD TOURNAMENT (8 players with ML3) ===
Tournament 3 started with 8 players (full capacity)
Round 0: 4 matches
Semifinal 0-0: 0x7099 vs 0x3C44
0x7099 wins semifinal 0-0
Semifinal 0-2: 0x976E vs 0x9965
0x976E wins semifinal 0-2
Semifinal 0-3: 0x14dC vs 0x2361
0x14dC wins semifinal 0-3
Semifinal 0-1: 0x90F7 vs 0x15d3
0x90F7 makes first move, then match stalls

â° Advancing time to Level 3 escalation window...

ðŸ”§ Using ML3 to end stalled match...
Caller: 0xa0Ee (external player, not enrolled)
âœ“ ML3 successfully ended stalled match
Match 0-1 status after ML3: Completed
Winner: 0xa0Ee

âœ“ Round 0 completed with ML3

Round 1: 2 matches
Match 1-0: 0x7099 vs 0xa0Ee
0x7099 wins match 1-0
Match 1-1: 0x14dC vs 0x976E
0x14dC wins match 1-1

Round 2: 1 matches
Match 2-0: 0x14dC vs 0x7099
0x14dC wins match 2-0

âœ“ Third tournament completed and reset successfully
âœ“ All 3 tournaments validated: 4 players, 7 players (Draw+ML2), 8 players (ML3)

âœ… HTML report updated: test-report-2026.html
      âœ” Should handle 3 consecutive 8-player tier tournaments with varying player counts and escalation scenarios (164ms)

  View Functions - All Games
    TicTacChain View Functions
      isMatchEscL2Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L2 delay
      isMatchEscL3Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L3 delay
      isPlayerInAdvancedRound
        âœ” Should return false for non-enrolled player
        âœ” Should return false for enrolled player who hasn't won any matches yet
    ConnectFourOnChain View Functions
      isMatchEscL2Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L2 delay
      isMatchEscL3Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L3 delay
      isPlayerInAdvancedRound
        âœ” Should return false for non-enrolled player
        âœ” Should return false for enrolled player who hasn't won any matches yet
    ChessOnChain View Functions
      isMatchEscL2Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L2 delay
      isMatchEscL3Available
        âœ” Should return false for non-existent match
        âœ” Should return false when player has not timed out
        âœ” Should return true after timeout + L3 delay
      isPlayerInAdvancedRound
        âœ” Should return false for non-enrolled player
        âœ” Should return false for enrolled player who hasn't won any matches yet

  Wei Precision and Rounding in Prize Distribution
    Wei Rounding in Prize Splits
      âœ” Should handle indivisible prize pool in finals draw (2 co-winners)
      âœ” Should handle wei remainder in 4-way all-draw split
      âœ” Should not lose wei in 8-player tournament prize distribution (44ms)
    Contract Balance Verification
      âœ” Should maintain zero contract balance after prize distribution
      âœ” Should accumulate protocol fees correctly across multiple tournaments
    Prize Distribution Precision
      âœ” Should handle standard entry fee precision correctly
      âœ” Should handle entry fee calculations with precision

  Chess Checkmate & Match Completion Tests
    Checkmate Detection
      âœ” Should detect Scholar's Mate and mark match as completed (59ms)
      âœ” Should detect Back Rank Mate
      âœ” Should detect checkmate and emit MatchCompleted event (57ms)
    Timeout Victory Match Completion
      âœ” Should complete match after timeout claim
      âœ” Should update player stats after timeout victory
    4-Player Tournament Progression
      âœ” Should advance winners to finals after round 0 completion (66ms)
      âœ” Should complete tournament after finals match
    Round Completion Logic
      âœ” Should mark round as complete when all matches finish
      âœ” Should increment completed matches count for each finished match

  ChessOnChain 8-Tier System Tests
    Tier Configuration Validation
      âœ” Should have exactly 8 tiers configured
    Boundary Tier Enrollment Tests
      Tier 0 (Lowest Fee 2-Player)
        âœ” Should accept correct entry fee
        âœ” Should reject incorrect entry fee
        âœ” Should auto-start when last slot fills
        âœ” Should split entry fees correctly (90/7.5/2.5)
      Tier 3 (Highest Fee 2-Player)
        âœ” Should accept correct entry fee
        âœ” Should reject incorrect entry fee
        âœ” Should auto-start when last slot fills
        âœ” Should split entry fees correctly (90/7.5/2.5)
      Tier 4 (Lowest Fee 4-Player)
        âœ” Should accept correct entry fee
        âœ” Should reject incorrect entry fee
        âœ” Should auto-start when last slot fills
        âœ” Should split entry fees correctly (90/7.5/2.5)
      Tier 7 (Highest Fee 4-Player)
        âœ” Should accept correct entry fee
        âœ” Should reject incorrect entry fee
        âœ” Should auto-start when last slot fills
        âœ” Should split entry fees correctly (90/7.5/2.5)
    2-Player Tier Progression
      âœ” Should complete Tier 0 tournament via checkmate (71ms)
      âœ” Should complete Tier 3 tournament via checkmate (72ms)
      âœ” Should complete Tier 0 tournament via timeout
      âœ” Should complete Tier 3 tournament via timeout
    4-Player Tier Progression
      âœ” Should complete Tier 4 semi-finals and finals via checkmate (234ms)
      âœ” Should complete Tier 7 semi-finals and finals via checkmate (238ms)
      âœ” Should handle mixed completion methods (timeout + checkmate) (170ms)
      âœ” Should handle Tier 7 mixed completion methods (127ms)
    Prize Distribution Validation
      âœ” Should distribute winner-takes-all correctly in Tier 0 (79ms)
      âœ” Should distribute winner-takes-all correctly in Tier 3 (75ms)
      âœ” Should distribute winner-takes-all correctly in Tier 4 (233ms)
      âœ” Should distribute winner-takes-all correctly in Tier 7 (243ms)
    Cross-Tier Independence
      âœ” Should allow player to enroll in multiple tiers simultaneously
      âœ” Should track prizes independently per tier (175ms)
      âœ” Should allow player in different instances of same tier
    Elite Matches Storage (Tier 3 and Tier 7)
      âœ” Should store Tier 3 finals match in eliteMatches array (78ms)
      âœ” Should store Tier 7 finals match in eliteMatches array (242ms)
      âœ” Should NOT store non-elite tier matches (Tier 1) (77ms)
      âœ” Should store complete move history in moves string for Tier 3 (75ms)
      âœ” Should store multiple elite matches sequentially (326ms)
      âœ” Should handle draw in elite finals correctly (79ms)

  ChessOnChain Tests
    Deployment
      âœ” Should deploy successfully
      âœ” Should have correct owner
    Check Status Bug Fix
      âœ” Should clear check status when player escapes check
      âœ” Should correctly track check status throughout a game
    Basic Game Flow
      âœ” Should allow a basic game to start
    1v1 Duel Match Initialization
      âœ” Should start match immediately after 2 players enroll in 1v1 duel
      âœ” Should allow immediate gameplay after match starts in 1v1 duel
      âœ” Should return correct status from all view functions after 1v1 duel starts
    Pawn Promotion
      âœ” Should allow pawn promotion to Queen
      âœ” Should reject promotion with PieceType.None
    Castling
      âœ” Should allow kingside castling
    Timeout Claims
      âœ” Should allow timeout claim after timeout period
      âœ” Should reject early timeout claim
      âœ” Should reject timeout claim on your own turn
    View Functions
      âœ” Should return chess match data
    Scholar's Mate (Checkmate)
      âœ” Should detect checkmate (Scholar's Mate) (54ms)
    4-Player Tournament
      âœ” Should handle 4-player tournament bracket

  Chess Fifty-Move Rule
    ChessRulesModule - Half-Move Clock Unit Tests
      âœ” Should start with half-move clock at 0
      âœ” Should increment half-move clock on non-pawn, non-capture moves
      âœ” Should reset half-move clock on pawn moves
      âœ” Should reset half-move clock on captures
      âœ” Should return gameEnd=3 when half-move clock reaches 100
      âœ” Should NOT trigger fifty-move rule at 99 half-moves
    ChessOnChain - Fifty-Move Rule Integration Tests
      âœ” Should track half-move clock during actual gameplay
      âœ” Should end game as draw via threefold repetition before fifty-move (expected behavior) (210ms)
      âœ” Should reset half-move clock on pawn move
      âœ” Should verify fifty-move rule logic at module level with high clock value
    Edge Cases
      âœ” Should correctly handle half-move clock with promotions (pawn move resets)
      âœ” Should handle en passant captures (both pawn move AND capture - resets clock)

  Chess Threefold Repetition Rule
    Position Tracking Basics
      âœ” Should not trigger draw after first occurrence of position
      âœ” Should not trigger draw after second occurrence of position
      âœ” Should track different positions without false positives
    Threefold Repetition Detection
      âœ” Should trigger draw on third repetition of starting position
      âœ” Should trigger draw on third repetition of non-starting position (39ms)
      âœ” Should NOT trigger draw after only two repetitions
    Position Hash Differentiation
      âœ” Should distinguish positions by side to move
      âœ” Should distinguish positions by castling rights
    Edge Cases
      âœ” Should handle rapid threefold with minimum moves
      âœ” Should allow pawn moves without resetting position counts
      âœ” Should correctly handle en passant affecting position uniqueness
    Integration with Other Draw Conditions
      âœ” Should prioritize checkmate over threefold repetition
      âœ” Should correctly track positions alongside fifty-move clock

  ConnectFour Edge Cases
    Column Full Detection
      âœ” Should reject move to column that is full (6 pieces)
      âœ” Should allow moves to other columns when one column is full

  ConnectFour Maximum Capacity Gas Estimation

ðŸš€ Initializing ConnectFour Maximum Capacity Gas Test...
âœ… Loaded 150 player accounts
âœ… ConnectFourOnChain deployed at 0x940Dc92F951B109520237686e4C4021C011024f6
    Phase 1: Contract Saturation Setup

ðŸ“‹ Enrolling players to saturate contract...

  Tier 0 (2-player): Enrolling 24 players across 12 instances...
    âœ“ 3/12 instances filled
    âœ“ 6/12 instances filled
    âœ“ 9/12 instances filled
    âœ“ 12/12 instances filled
  âœ… Tier 0 complete: 24 players enrolled

  Tier 1 (4-player): Enrolling 40 players across 10 instances...
    âœ“ 3/10 instances filled
    âœ“ 6/10 instances filled
    âœ“ 9/10 instances filled
  âœ… Tier 1 complete: 40 players enrolled

  Tier 2 (8-player): Enrolling 64 players across 8 instances...
    âœ“ 2/8 instances filled
    âœ“ 4/8 instances filled
    âœ“ 6/8 instances filled
    âœ“ 8/8 instances filled
  âœ… Tier 2 complete: 64 players enrolled

âœ… CONTRACT SATURATION COMPLETE
   Total Players: 128 = 128 enrolled (Tier 3 removed)
   Active Tournaments: 30
      âœ” Should saturate contract with 128 players across all tiers (250ms)
    Phase 2: Worst-Case Gas Measurement

ðŸŽ® SCENARIO 1: Long Game (20+ moves)

    ðŸ“Š Playing long game (20 moves)
      Move 5/20 complete - Gas: 76898
      Move 10/20 complete - Gas: 79142
      Move 15/20 complete - Gas: 79018
      Move 20/20 complete - Gas: 78573
    âœ… Long game complete - 20 moves played
      âœ” Scenario 1: Long Game with Multiple Moves (42ms)

ðŸš€ SCENARIO 2: Tournament Auto-Start
    Enrolling final player to trigger auto-start...

    ðŸ’Ž AUTO-START GAS COST
       Gas: 914,094
       Cost: 0.000914094006398658 ETH ($2.74)
      âœ” Scenario 2: Tournament Auto-Start at Capacity
    Phase 3: Per-Player Cost Analysis

ðŸ“Š Calculating average player costs...

    Players tracked: 136
    Average gas per player: 260,394
    Average cost @ 0.05 gwei: 0.0000130197 ETH
      âœ” Should calculate average player cost across all scenarios

ðŸŽ¯ Identifying maximum cost player...

    Max cost player: 0x011bD5423C5F77b5a0789E27f922535fd76B688F
    Total gas: 1,021,157
    Transactions: 11

    Top 5 expensive transactions:
      1. Enrollment: Tier 2, Instance 1, Player 1: 236,673 gas
      2. Move 18/20 (col 3): 81,107 gas
      3. Move 16/20 (col 1): 80,357 gas
      4. Move 10/20 (col 2): 79,142 gas
      5. Move 12/20 (col 4): 79,142 gas
      âœ” Should identify maximum cost player path

ðŸ’° Network Cost Estimates at Various Gas Prices

    Gas Prices (L2): 0.03, 0.1, 0.5, 1.0 gwei
    ETH Price Assumption: $3,000

    0.03 gwei:
      Average: 0.00000781182 ETH ($0.02)
      Maximum: 0.00003063471 ETH ($0.09)

    0.1 gwei:
      Average: 0.0000260394 ETH ($0.08)
      Maximum: 0.0001021157 ETH ($0.31)

    0.5 gwei:
      Average: 0.000130197 ETH ($0.39)
      Maximum: 0.0005105785 ETH ($1.53)

    1 gwei:
      Average: 0.000260394 ETH ($0.78)
      Maximum: 0.001021157 ETH ($3.06)
      âœ” Should display network cost estimates at various gas prices
    Phase 4: Generate Comprehensive Report

================================================================================
CONNECTFOUR MAXIMUM CAPACITY GAS ESTIMATION REPORT
================================================================================

## Contract State at Test Time
- Total Players Enrolled: 128
- Active Tournament Instances: 30
- Tier 0: 12 instances Ã— 2 players = 24 players
- Tier 1: 10 instances Ã— 4 players = 40 players
- Tier 2: 8 instances Ã— 8 players = 64 players
- Total: 128 players (Tier 3 removed in new architecture)
- Estimated Concurrent Matches: ~62
- Match Cache Utilization: moderate

## Gas Costs by Operation (Top 20 Highest)

1. Enrollment: Tier 2, Instance 5, Player 8
   Gas Used: 914,112
   Cost @ 0.05 gwei: 0.000914112006398784 ETH ($2.74)
   Player: 0x11c9CFEc...

2. Enrollment: Tier 2, Instance 2, Player 8
   Gas Used: 914,094
   Cost @ 0.05 gwei: 0.000914094006398658 ETH ($2.74)
   Player: 0xE5D3ab68...

3. Enrollment: Tier 2, Instance 4, Player 8
   Gas Used: 914,094
   Cost @ 0.05 gwei: 0.000914094006398658 ETH ($2.74)
   Player: 0x9c793571...

4. Enrollment: Tier 2, Instance 6, Player 8
   Gas Used: 914,094
   Cost @ 0.05 gwei: 0.000914094006398658 ETH ($2.74)
   Player: 0xc9DB8bec...

5. Enrollment: Tier 2, Instance 7, Player 8
   Gas Used: 914,094
   Cost @ 0.05 gwei: 0.000914094006398658 ETH ($2.74)
   Player: 0x20a6250c...

6. Auto-Start Trigger: Tier 2 enrollment (8th player)
   Gas Used: 914,094
   Cost @ 0.05 gwei: 0.000914094006398658 ETH ($2.74)
   Player: 0x527601C7...

7. Enrollment: Tier 2, Instance 1, Player 8
   Gas Used: 914,076
   Cost @ 0.05 gwei: 0.000914076006398532 ETH ($2.74)
   Player: 0x586BA390...

8. Enrollment: Tier 2, Instance 0, Player 8
   Gas Used: 914,046
   Cost @ 0.05 gwei: 0.000914046006398322 ETH ($2.74)
   Player: 0xF0cE7BaB...

9. Enrollment: Tier 2, Instance 3, Player 8
   Gas Used: 914,040
   Cost @ 0.05 gwei: 0.00091404000639828 ETH ($2.74)
   Player: 0xBc5BdceE...

10. Enrollment: Tier 1, Instance 4, Player 4
   Gas Used: 538,274
   Cost @ 0.05 gwei: 0.000538274003767918 ETH ($1.61)
   Player: 0xC004e69C...

11. Enrollment: Tier 1, Instance 6, Player 4
   Gas Used: 538,274
   Cost @ 0.05 gwei: 0.000538274003767918 ETH ($1.61)
   Player: 0xD6A098Eb...

12. Enrollment: Tier 1, Instance 7, Player 4
   Gas Used: 538,274
   Cost @ 0.05 gwei: 0.000538274003767918 ETH ($1.61)
   Player: 0xAb707cb8...

13. Enrollment: Tier 1, Instance 1, Player 4
   Gas Used: 538,256
   Cost @ 0.05 gwei: 0.000538256003767792 ETH ($1.61)
   Player: 0xcF2d5b3c...

14. Enrollment: Tier 1, Instance 2, Player 4
   Gas Used: 538,256
   Cost @ 0.05 gwei: 0.000538256003767792 ETH ($1.61)
   Player: 0x1003ff39...

15. Enrollment: Tier 1, Instance 3, Player 4
   Gas Used: 538,256
   Cost @ 0.05 gwei: 0.000538256003767792 ETH ($1.61)
   Player: 0x9eF6c02F...

16. Enrollment: Tier 1, Instance 8, Player 4
   Gas Used: 538,256
   Cost @ 0.05 gwei: 0.000538256003767792 ETH ($1.61)
   Player: 0xC0543b0b...

17. Enrollment: Tier 1, Instance 9, Player 4
   Gas Used: 538,256
   Cost @ 0.05 gwei: 0.000538256003767792 ETH ($1.61)
   Player: 0x64492E25...

18. Enrollment: Tier 1, Instance 0, Player 4
   Gas Used: 538,244
   Cost @ 0.05 gwei: 0.000538244003767708 ETH ($1.61)
   Player: 0x40Fc963A...

19. Enrollment: Tier 1, Instance 5, Player 4
   Gas Used: 538,238
   Cost @ 0.05 gwei: 0.000538238003767666 ETH ($1.61)
   Player: 0x35304262...

20. Enrollment: Tier 0, Instance 3, Player 2
   Gas Used: 350,343
   Cost @ 0.05 gwei: 0.000350343002452401 ETH ($1.05)
   Player: 0x23618e81...

## Average Player Cost Analysis
- Players Tracked: 136
- Total Gas (All Players): 35,413,591
- Average Gas per Player: 260,394
- Average Cost @ 0.05 gwei: 0.0000130197 ETH
- Average Cost @ 0.05 gwei: $0.04

## Maximum Cost Player
- Player Address: 0x011bD5423C5F77b5a0789E27f922535fd76B688F
- Total Gas Spent: 1,021,157
- Total Transactions: 11
- Cost @ 0.05 gwei: 0.00005105785 ETH
- Cost @ 0.05 gwei: $0.15

  Top 5 Most Expensive Transactions for Max Cost Player:
    1. Enrollment: Tier 2, Instance 1, Player 1: 236,673 gas
    2. Move 18/20 (col 3): 81,107 gas
    3. Move 16/20 (col 1): 80,357 gas
    4. Move 10/20 (col 2): 79,142 gas
    5. Move 12/20 (col 4): 79,142 gas

## Network Cost Estimates at Different Gas Prices (L2)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Gas Price  â”‚ Avg Player Cost  â”‚ Max Player Cost  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0.03 gwei  â”‚ 0.00000781182    â”‚ 0.00003063471    â”‚
â”‚            â”‚ ($0.02         ) â”‚ ($0.09         ) â”‚
â”‚ 0.1 gwei   â”‚ 0.0000260394     â”‚ 0.0001021157     â”‚
â”‚            â”‚ ($0.08         ) â”‚ ($0.31         ) â”‚
â”‚ 0.5 gwei   â”‚ 0.000130197      â”‚ 0.0005105785     â”‚
â”‚            â”‚ ($0.39         ) â”‚ ($1.53         ) â”‚
â”‚ 1 gwei     â”‚ 0.000260394      â”‚ 0.001021157      â”‚
â”‚            â”‚ ($0.78         ) â”‚ ($3.06         ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## Operation Type Breakdown

ENROLLMENTS:
  Count: 1
  Total Gas: 914,094
  Average Gas: 914,094

MOVES:
  Count: 20
  Total Gas: 1,604,046
  Average Gas: 80,202

================================================================================
END OF REPORT
================================================================================

      âœ” Should print comprehensive gas analysis report

  ConnectFourOnChain ETour Compatibility Tests
    Deployment and Tier Configuration
      âœ” Should deploy successfully as ETour implementation
      âœ” Should have 3 tiers configured
    Tournament Enrollment (ETour Integration)
      âœ” Should allow player enrollment
      âœ” Should auto-start 2-player tournament when full
      âœ” Should correctly split entry fees (90% prize pool)
      âœ” Should reject incorrect entry fee
      âœ” Should reject duplicate enrollment
    Match Creation (ETour Integration)
      âœ” Should create match when tournament starts
      âœ” Should initialize empty board
      âœ” Should set random first player
    Game Play (Connect Four Logic)
      âœ” Should allow first player to make move
      âœ” Should place piece at bottom of column (gravity)
      âœ” Should stack pieces correctly
      âœ” Should switch turns after each move
      âœ” Should reject move when not your turn
      âœ” Should reject move to full column
      âœ” Should reject invalid column
    Win Detection
      âœ” Should detect horizontal win
      âœ” Should detect vertical win
    Tournament Completion (ETour Integration)
      âœ” Should complete tournament and distribute prizes
      âœ” Should update player stats after match
    4-Player Tournament (Multi-Round)
      âœ” Should handle 4-player tournament bracket
    Timeout Functions (ETour Integration)
      âœ” Should allow timeout claim after timeout period
      âœ” Should reject early timeout claim
    View Functions
      âœ” Should return match data correctly
    Round-Based Prize Distribution (8-Player Tournament)
      âœ” Should start 8-player tournament with correct bracket structure
      âœ” Should award 0% to semi-final losers (3rd and 4th place) (77ms)
      âœ” Should award 0% to round 0 losers (5th-8th place) (74ms)
    ABI Compatibility with ETour
      âœ” Should have all ETour required functions
      âœ” Should have Connect Four specific functions

  PlayerMatches - Complete MatchRecord Tracking
    Normal Win Scenario
      âœ” Should create MatchRecords for both players on normal win
    Timeout Win (ML1) Scenario
      âœ” Should create MatchRecords for both players on timeout win
    Draw Scenario
      âœ” Should create MatchRecords for both players on draw
    Force Elimination (ML2) Scenario
      âœ” Should create MatchRecords for both eliminated players with no winner (38ms)
    Replacement (ML3) Scenario
      âœ” Should create MatchRecords for all 3 players (original p1, p2, and replacement)
    Multi-Round Tracking
      âœ” Should track all matches for a player across multiple rounds (60ms)

  TicTacChain Progressive Raffle Thresholds
    Progressive Threshold Configuration
      âœ” Should have 0.001 ETH threshold for raffle #1 (index 0)
      âœ” Should have 5% reserve for TicTacChain
      âœ” Should calculate raffle amount correctly with 5% reserve
    Threshold Progression
      âœ” Should progress from 0.001 to 0.005 ETH after first raffle
      âœ” Should cap at 1.0 ETH for raffle #8 and beyond
    Raffle Index Tracking
      âœ” Should start with currentRaffleIndex = 0
      âœ” Should show raffleIndex in getRaffleInfo
    Protocol Fee Accumulation with Low Threshold
      âœ” Should accumulate protocol fees toward 0.001 ETH threshold
      âœ” Should show accurate progress toward threshold
    Distribution with 5% Reserve
      âœ” Should calculate 95% distribution with 5% reserve
    Comparison with Base ETour
      âœ” TicTacChain should have lower threshold than base ETour default
      âœ” Both should use 5% proportional reserve
    Threshold Scaling Examples
      âœ” Should document threshold and reserve progression


  490 passing (5m)
  17 pending

  Threshold Scaling Examples
      âœ” Should document threshold and reserve progression


  490 passing (5m)
  17 pending

